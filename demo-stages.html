<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hushful Garden - Stages Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Georgia', serif;
            background: #1a1a2e;
            color: #e8e8f0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #f0e0d0;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #a0a0b0;
            font-size: 14px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .controls button.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-dawn { background: linear-gradient(135deg, #e080a0, #f8a088); color: #3a2030; }
        .btn-day { background: linear-gradient(135deg, #50a8c0, #80c8d8); color: #1a3040; }
        .btn-golden { background: linear-gradient(135deg, #e0a050, #f8c060); color: #3a2010; }
        .btn-dusk { background: linear-gradient(135deg, #c060a0, #e080a0); color: #2a1030; }
        .btn-night { background: linear-gradient(135deg, #203050, #304060); color: #c0c0d0; }

        .stages { max-width: 900px; margin: 0 auto; }
        .stage {
            margin-bottom: 30px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .stage-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .stage-number {
            font-size: 12px;
            color: #808090;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #f0e8e0;
            margin-left: 10px;
        }
        .stage-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .metric {
            font-size: 11px;
            color: #909098;
        }
        .metric span {
            color: #c0b8b0;
            font-weight: 600;
        }
        .canvas-container {
            width: 100%;
            height: 300px;
            background: #101018;
        }
        .canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .stage-description {
            padding: 15px 20px;
            font-size: 13px;
            color: #a0a0a8;
            font-style: italic;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <h1>Hushful Garden Stages</h1>
    <p class="subtitle">Kawase Hasui woodblock print style - watch your garden grow with your metabolic health</p>

    <div class="controls">
        <button class="btn-dawn" onclick="setTimeOfDay(0.25)">Dawn</button>
        <button class="btn-day active" onclick="setTimeOfDay(0.5)">Day</button>
        <button class="btn-golden" onclick="setTimeOfDay(0.68)">Golden Hour</button>
        <button class="btn-dusk" onclick="setTimeOfDay(0.78)">Dusk</button>
        <button class="btn-night" onclick="setTimeOfDay(0.95)">Night</button>
    </div>

    <div id="stages" class="stages"></div>

    <script>
        // ═══════════════════════════════════════════════════════════════════
        // STAGE DEFINITIONS
        // ═══════════════════════════════════════════════════════════════════

        const stages = [
            {
                title: 'Stage 1 - New Beginning',
                description: 'A new user just starting their journey. The garden is sparse but full of potential.',
                health: 0.2,
                metrics: { engagement: 0.1, food: 0.1, ketone: 0.2, glucose: 0.3 },
                plants: [
                    { x: 0.5, type: 'flowers', growth: 0.3, layer: 2 },
                    { x: 0.3, type: 'flowers', growth: 0.2, layer: 2 },
                ]
            },
            {
                title: 'Stage 2 - First Sprouts',
                description: 'A week of engagement. Small bushes appear, flowers begin to bloom.',
                health: 0.35,
                metrics: { engagement: 0.3, food: 0.25, ketone: 0.35, glucose: 0.4 },
                plants: [
                    { x: 0.4, type: 'bush', growth: 0.4, layer: 1 },
                    { x: 0.25, type: 'flowers', growth: 0.5, layer: 2 },
                    { x: 0.6, type: 'flowers', growth: 0.4, layer: 2 },
                    { x: 0.8, type: 'flowers', growth: 0.3, layer: 2 },
                ]
            },
            {
                title: 'Stage 3 - Growing Strong',
                description: 'Two weeks of consistent tracking. The first tree takes root!',
                health: 0.5,
                metrics: { engagement: 0.5, food: 0.45, ketone: 0.5, glucose: 0.55 },
                plants: [
                    { x: 0.2, type: 'tree', growth: 0.5, layer: 0 },
                    { x: 0.5, type: 'bush', growth: 0.6, layer: 1 },
                    { x: 0.7, type: 'bush', growth: 0.5, layer: 1 },
                    { x: 0.35, type: 'flowers', growth: 0.6, layer: 2 },
                    { x: 0.6, type: 'flowers', growth: 0.7, layer: 2 },
                    { x: 0.85, type: 'flowers', growth: 0.5, layer: 2 },
                ]
            },
            {
                title: 'Stage 4 - Flourishing',
                description: 'A month of dedication. Multiple trees, lush bushes, vibrant flowers.',
                health: 0.7,
                metrics: { engagement: 0.7, food: 0.65, ketone: 0.7, glucose: 0.75 },
                plants: [
                    { x: 0.15, type: 'tree', growth: 0.7, layer: 0 },
                    { x: 0.8, type: 'tree', growth: 0.6, layer: 0 },
                    { x: 0.35, type: 'bush', growth: 0.75, layer: 1 },
                    { x: 0.6, type: 'bush', growth: 0.7, layer: 1 },
                    { x: 0.2, type: 'flowers', growth: 0.8, layer: 2 },
                    { x: 0.45, type: 'flowers', growth: 0.85, layer: 2 },
                    { x: 0.7, type: 'flowers', growth: 0.75, layer: 2 },
                    { x: 0.9, type: 'flowers', growth: 0.7, layer: 2 },
                ]
            },
            {
                title: 'Stage 5 - Paradise',
                description: 'Metabolic mastery achieved! A thriving garden that reflects your vibrant health.',
                health: 0.9,
                metrics: { engagement: 0.9, food: 0.85, ketone: 0.9, glucose: 0.92 },
                plants: [
                    { x: 0.12, type: 'tree', growth: 0.9, layer: 0 },
                    { x: 0.5, type: 'tree', growth: 0.85, layer: 0 },
                    { x: 0.88, type: 'tree', growth: 0.8, layer: 0 },
                    { x: 0.28, type: 'bush', growth: 0.9, layer: 1 },
                    { x: 0.65, type: 'bush', growth: 0.85, layer: 1 },
                    { x: 0.15, type: 'flowers', growth: 0.95, layer: 2 },
                    { x: 0.35, type: 'flowers', growth: 0.9, layer: 2 },
                    { x: 0.55, type: 'flowers', growth: 0.92, layer: 2 },
                    { x: 0.75, type: 'flowers', growth: 0.88, layer: 2 },
                    { x: 0.92, type: 'flowers', growth: 0.85, layer: 2 },
                ]
            }
        ];

        let currentTimeOfDay = 0.5; // Start at midday

        // ═══════════════════════════════════════════════════════════════════
        // KAWASE HASUI COLOR PALETTES
        // ═══════════════════════════════════════════════════════════════════

        const palettes = {
            dawn: {
                skyTop: '#4a5580',
                skyMid: '#8060a0',
                skyLow: '#e080a0',
                skyHorizon: '#f8a088',
                clouds: '#ff90b0',
                cloudShadow: '#c060a0',
                sun: '#ffcc88',
                sunGlow: '#ff9060',
                hillFar: '#406858',
                hillMid: '#305848',
                hillNear: '#204838',
                groundFar: '#386048',
                groundMid: '#285038',
                groundNear: '#1a4030',
                flower1: '#ff7090',
                flower2: '#ffaa60',
                flower3: '#90d0ff',
                tree: '#1a3828',
                treeFoliage: '#2a5838',
                path: '#c8a878'
            },
            day: {
                skyTop: '#3080a0',
                skyMid: '#50a8c0',
                skyLow: '#80c8d8',
                skyHorizon: '#c0e0e8',
                clouds: '#f0f8ff',
                cloudShadow: '#a0c8d8',
                sun: '#fff8e0',
                sunGlow: '#ffe8b0',
                hillFar: '#508868',
                hillMid: '#407858',
                hillNear: '#306848',
                groundFar: '#488858',
                groundMid: '#387848',
                groundNear: '#286838',
                flower1: '#ff6080',
                flower2: '#ffa050',
                flower3: '#80c0ff',
                tree: '#1a3020',
                treeFoliage: '#285028',
                path: '#d8b888'
            },
            golden: {
                skyTop: '#5070a0',
                skyMid: '#a08850',
                skyLow: '#e0a050',
                skyHorizon: '#f8c060',
                clouds: '#ffd080',
                cloudShadow: '#c89040',
                sun: '#fff0a0',
                sunGlow: '#ffc040',
                hillFar: '#607048',
                hillMid: '#506038',
                hillNear: '#405028',
                groundFar: '#587040',
                groundMid: '#486030',
                groundNear: '#385020',
                flower1: '#ff8060',
                flower2: '#ffc040',
                flower3: '#a0d080',
                tree: '#283018',
                treeFoliage: '#384820',
                path: '#e0c090'
            },
            dusk: {
                skyTop: '#3048a0',
                skyMid: '#6050a0',
                skyLow: '#c060a0',
                skyHorizon: '#e080a0',
                clouds: '#e888c0',
                cloudShadow: '#9050a0',
                sun: '#ffa080',
                sunGlow: '#ff7060',
                hillFar: '#484870',
                hillMid: '#383860',
                hillNear: '#282850',
                groundFar: '#404068',
                groundMid: '#303058',
                groundNear: '#202048',
                flower1: '#ff70c0',
                flower2: '#ffa080',
                flower3: '#80a0ff',
                tree: '#181830',
                treeFoliage: '#282848',
                path: '#9080a0'
            },
            night: {
                skyTop: '#101830',
                skyMid: '#182040',
                skyLow: '#203050',
                skyHorizon: '#304060',
                clouds: '#384868',
                cloudShadow: '#202840',
                moon: '#e0e8ff',
                moonGlow: '#8090c0',
                hillFar: '#1a2838',
                hillMid: '#142030',
                hillNear: '#101828',
                groundFar: '#182030',
                groundMid: '#101828',
                groundNear: '#0a1020',
                flower1: '#6080a0',
                flower2: '#7090a0',
                flower3: '#5070a0',
                tree: '#0a1018',
                treeFoliage: '#101820',
                path: '#384050'
            }
        };

        function getPalette(t) {
            if (t < 0.22) return lerpPalette(palettes.night, palettes.dawn, t / 0.22);
            if (t < 0.35) return lerpPalette(palettes.dawn, palettes.day, (t - 0.22) / 0.13);
            if (t < 0.6) return palettes.day;
            if (t < 0.72) return lerpPalette(palettes.day, palettes.golden, (t - 0.6) / 0.12);
            if (t < 0.82) return lerpPalette(palettes.golden, palettes.dusk, (t - 0.72) / 0.1);
            if (t < 0.92) return lerpPalette(palettes.dusk, palettes.night, (t - 0.82) / 0.1);
            return palettes.night;
        }

        function lerpPalette(p1, p2, t) {
            const result = {};
            for (const key in p1) {
                if (typeof p1[key] === 'string' && p1[key].startsWith('#')) {
                    result[key] = lerpColor(p1[key], p2[key], t);
                } else {
                    result[key] = p1[key];
                }
            }
            return result;
        }

        function lerpColor(c1, c2, t) {
            const r1 = parseInt(c1.slice(1,3), 16), g1 = parseInt(c1.slice(3,5), 16), b1 = parseInt(c1.slice(5,7), 16);
            const r2 = parseInt(c2.slice(1,3), 16), g2 = parseInt(c2.slice(3,5), 16), b2 = parseInt(c2.slice(5,7), 16);
            const r = Math.round(r1 + (r2 - r1) * t);
            const g = Math.round(g1 + (g2 - g1) * t);
            const b = Math.round(b1 + (b2 - b1) * t);
            return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
        }

        function seededRandom(seed) {
            const x = Math.sin(seed * 127.1 + seed * 311.7) * 43758.5453;
            return x - Math.floor(x);
        }

        // ═══════════════════════════════════════════════════════════════════
        // DRAWING FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════

        function drawSky(ctx, p, w, h) {
            const gradient = ctx.createLinearGradient(0, 0, 0, h * 0.7);
            gradient.addColorStop(0, p.skyTop);
            gradient.addColorStop(0.35, p.skyMid);
            gradient.addColorStop(0.7, p.skyLow);
            gradient.addColorStop(1, p.skyHorizon);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
        }

        function drawClouds(ctx, p, w, h, time) {
            if (!p.clouds || p.clouds === p.cloudShadow) return;

            const cloudData = [
                { x: 0.15, y: 0.1, scale: 1.0, seed: 1 },
                { x: 0.55, y: 0.06, scale: 1.3, seed: 2 },
                { x: 0.85, y: 0.12, scale: 0.9, seed: 3 },
            ];

            cloudData.forEach(cloud => {
                const cx = (cloud.x + time * 0.008 * (0.5 + cloud.seed * 0.2)) % 1.2 - 0.1;
                const scale = cloud.scale * 40;

                ctx.save();
                ctx.translate(cx * w, cloud.y * h);

                ctx.fillStyle = p.cloudShadow;
                drawCloudShape(ctx, 2, 4, scale);
                ctx.fillStyle = p.clouds;
                drawCloudShape(ctx, 0, 0, scale);

                ctx.restore();
            });
        }

        function drawCloudShape(ctx, ox, oy, scale) {
            ctx.beginPath();
            ctx.ellipse(ox, oy, scale * 1.2, scale * 0.5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(ox - scale * 0.5, oy + scale * 0.1, scale * 0.6, scale * 0.35, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(ox + scale * 0.4, oy + scale * 0.05, scale * 0.7, scale * 0.4, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawSun(ctx, p, w, h, timeOfDay) {
            const isNight = timeOfDay < 0.22 || timeOfDay > 0.85;

            if (isNight) {
                // Moon
                ctx.fillStyle = p.moonGlow || '#8090c0';
                ctx.beginPath();
                ctx.arc(w * 0.8, h * 0.12, 25, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = p.moon || '#e0e8ff';
                ctx.beginPath();
                ctx.arc(w * 0.8, h * 0.12, 16, 0, Math.PI * 2);
                ctx.fill();

                // Stars
                for (let i = 0; i < 25; i++) {
                    const sx = seededRandom(i * 7) * w;
                    const sy = seededRandom(i * 11) * h * 0.4;
                    const size = 0.8 + seededRandom(i * 3) * 1.5;
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.3 + seededRandom(i * 5) * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(sx, sy, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                const dayProgress = (timeOfDay - 0.22) / 0.63;
                const sunX = w * (0.15 + dayProgress * 0.7);
                const sunY = h * (0.3 - Math.sin(dayProgress * Math.PI) * 0.2);

                ctx.fillStyle = p.sunGlow;
                ctx.beginPath();
                ctx.arc(sunX, sunY, 32, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = p.sun;
                ctx.beginPath();
                ctx.arc(sunX, sunY, 20, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawHills(ctx, p, w, h) {
            // Far
            ctx.fillStyle = p.hillFar;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.5);
            for (let x = 0; x <= w; x += 15) {
                const y = h * 0.5 + Math.sin(x * 0.01) * 20 + Math.sin(x * 0.004) * 35;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();

            // Mid
            ctx.fillStyle = p.hillMid;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.58);
            for (let x = 0; x <= w; x += 12) {
                const y = h * 0.58 + Math.sin(x * 0.012 + 1) * 18 + Math.sin(x * 0.005) * 28;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();

            // Near
            ctx.fillStyle = p.hillNear;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.65);
            for (let x = 0; x <= w; x += 8) {
                const y = h * 0.65 + Math.sin(x * 0.015 + 2) * 14 + Math.sin(x * 0.006) * 20;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();
        }

        function drawGround(ctx, p, w, h) {
            ctx.fillStyle = p.groundFar;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.72);
            for (let x = 0; x <= w; x += 6) {
                const y = h * 0.72 + Math.sin(x * 0.018 + 3) * 8;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = p.groundMid;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.8);
            for (let x = 0; x <= w; x += 5) {
                const y = h * 0.8 + Math.sin(x * 0.022 + 4) * 6;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = p.groundNear;
            ctx.beginPath();
            ctx.moveTo(0, h * 0.87);
            for (let x = 0; x <= w; x += 4) {
                const y = h * 0.87 + Math.sin(x * 0.028 + 5) * 4;
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fill();
        }

        function drawPath(ctx, p, w, h) {
            ctx.fillStyle = p.path;
            ctx.beginPath();
            ctx.moveTo(w * 0.45, h);
            ctx.bezierCurveTo(w * 0.42, h * 0.92, w * 0.48, h * 0.84, w * 0.44, h * 0.76);
            ctx.bezierCurveTo(w * 0.40, h * 0.70, w * 0.46, h * 0.66, w * 0.43, h * 0.62);
            ctx.lineTo(w * 0.47, h * 0.62);
            ctx.bezierCurveTo(w * 0.50, h * 0.66, w * 0.44, h * 0.70, w * 0.48, h * 0.76);
            ctx.bezierCurveTo(w * 0.52, h * 0.84, w * 0.46, h * 0.92, w * 0.52, h);
            ctx.closePath();
            ctx.fill();
        }

        function drawGardener(ctx, p, w, h, time) {
            const x = w * 0.46;
            const y = h * 0.74 + Math.sin(time * 2) * 1.5;
            const scale = 0.55;
            const ht = 40 * scale;

            ctx.save();
            ctx.translate(x, y);

            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.beginPath();
            ctx.ellipse(0, 2, 10 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Legs
            ctx.fillStyle = '#3a4858';
            ctx.fillRect(-4 * scale, -ht * 0.35, 3.5 * scale, ht * 0.35);
            ctx.fillRect(0.5 * scale, -ht * 0.35, 3.5 * scale, ht * 0.35);

            // Body
            ctx.fillStyle = '#6a8860';
            ctx.beginPath();
            ctx.moveTo(-7 * scale, -ht * 0.35);
            ctx.lineTo(-8 * scale, -ht * 0.75);
            ctx.lineTo(8 * scale, -ht * 0.75);
            ctx.lineTo(7 * scale, -ht * 0.35);
            ctx.closePath();
            ctx.fill();

            // Arms
            ctx.fillStyle = '#d0a888';
            ctx.fillRect(-10 * scale, -ht * 0.7, 3.5 * scale, 12 * scale);
            ctx.fillRect(6.5 * scale, -ht * 0.7, 3.5 * scale, 12 * scale);

            // Head
            ctx.fillStyle = '#e0b898';
            ctx.beginPath();
            ctx.arc(0, -ht * 0.85, 7 * scale, 0, Math.PI * 2);
            ctx.fill();

            // Hair
            ctx.fillStyle = '#4a3828';
            ctx.beginPath();
            ctx.arc(0, -ht * 0.88, 7.5 * scale, Math.PI, Math.PI * 2);
            ctx.fill();

            // Hat
            ctx.fillStyle = '#d8c090';
            ctx.beginPath();
            ctx.ellipse(0, -ht * 0.95, 12 * scale, 3.5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#c8b080';
            ctx.beginPath();
            ctx.ellipse(0, -ht, 7 * scale, 5 * scale, 0, Math.PI, Math.PI * 2);
            ctx.fill();

            // Tool
            ctx.fillStyle = '#708898';
            ctx.fillRect(8 * scale, -ht * 0.5, 7 * scale, 10 * scale);
            ctx.fillRect(12 * scale, -ht * 0.6, 5 * scale, 3.5 * scale);

            ctx.restore();
        }

        function drawTree(ctx, x, y, scale, p, seed) {
            const ht = 90 * scale;

            ctx.save();
            ctx.translate(x, y);

            // Trunk
            ctx.fillStyle = p.tree;
            ctx.beginPath();
            ctx.moveTo(-6 * scale, 0);
            ctx.lineTo(-5 * scale, -ht * 0.4);
            ctx.lineTo(5 * scale, -ht * 0.4);
            ctx.lineTo(6 * scale, 0);
            ctx.closePath();
            ctx.fill();

            // Foliage layers
            const layers = [
                { cy: -ht * 0.5, rx: 28, ry: 20 },
                { cy: -ht * 0.65, rx: 32, ry: 22 },
                { cy: -ht * 0.8, rx: 26, ry: 18 },
                { cy: -ht * 0.92, rx: 18, ry: 13 },
            ];

            layers.forEach((layer, i) => {
                ctx.fillStyle = lerpColor(p.treeFoliage, p.tree, i * 0.15);
                ctx.beginPath();
                ctx.ellipse(0, layer.cy, layer.rx * scale, layer.ry * scale, 0, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.restore();
        }

        function drawBush(ctx, x, y, scale, p, seed) {
            const colors = [p.groundNear, p.groundMid, p.hillNear];

            ctx.save();
            ctx.translate(x, y);

            const blobs = [
                { ox: -12, oy: -8, r: 18 },
                { ox: 8, oy: -12, r: 20 },
                { ox: -4, oy: -20, r: 16 },
                { ox: 12, oy: -6, r: 14 },
            ];

            blobs.forEach((blob, i) => {
                ctx.fillStyle = colors[i % 3];
                ctx.beginPath();
                ctx.arc(blob.ox * scale, blob.oy * scale, blob.r * scale, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.restore();
        }

        function drawFlower(ctx, x, y, color, scale, seed) {
            const ht = 20 * scale;
            const petalSize = 5 * scale;

            ctx.save();
            ctx.translate(x, y);

            // Stem
            ctx.strokeStyle = '#2a5030';
            ctx.lineWidth = 1.5 * scale;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(Math.sin(seed) * 2, -ht);
            ctx.stroke();

            // Petals
            ctx.fillStyle = color;
            const petals = 5 + Math.floor(seededRandom(seed) * 3);
            for (let i = 0; i < petals; i++) {
                const angle = (i / petals) * Math.PI * 2;
                const px = Math.cos(angle) * petalSize * 0.7;
                const py = -ht + Math.sin(angle) * petalSize * 0.7;
                ctx.beginPath();
                ctx.arc(px, py, petalSize * 0.5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Center
            ctx.fillStyle = '#ffc040';
            ctx.beginPath();
            ctx.arc(0, -ht, petalSize * 0.35, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        function drawFlowerCluster(ctx, x, y, p, count, seed) {
            const colors = [p.flower1, p.flower2, p.flower3];
            for (let i = 0; i < count; i++) {
                const fx = x + (seededRandom(seed + i) - 0.5) * 35;
                const fy = y + (seededRandom(seed + i + 100) - 0.5) * 12;
                const color = colors[Math.floor(seededRandom(seed + i + 50) * 3)];
                const sc = 0.5 + seededRandom(seed + i + 200) * 0.5;
                drawFlower(ctx, fx, fy, color, sc, seed + i);
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // SCENE RENDERING
        // ═══════════════════════════════════════════════════════════════════

        function drawScene(ctx, stage, w, h, time) {
            const p = getPalette(currentTimeOfDay);

            ctx.clearRect(0, 0, w, h);

            drawSky(ctx, p, w, h);
            drawSun(ctx, p, w, h, currentTimeOfDay);
            drawClouds(ctx, p, w, h, time);
            drawHills(ctx, p, w, h);
            drawGround(ctx, p, w, h);
            drawPath(ctx, p, w, h);

            // Trees
            stage.plants.filter(pl => pl.type === 'tree').forEach((pl, i) => {
                drawTree(ctx, pl.x * w, h * 0.70, pl.growth * 0.7, p, i * 137 + pl.x * 1000);
            });

            // Bushes
            stage.plants.filter(pl => pl.type === 'bush').forEach((pl, i) => {
                drawBush(ctx, pl.x * w, h * 0.78, pl.growth * 0.65, p, i * 137 + pl.x * 1000);
            });

            // Gardener
            drawGardener(ctx, p, w, h, time);

            // Flowers
            stage.plants.filter(pl => pl.type === 'flowers').forEach((pl, i) => {
                const flowerCount = 4 + Math.floor(pl.growth * 5);
                drawFlowerCluster(ctx, pl.x * w, h * 0.85, p, flowerCount, i * 137 + pl.x * 1000);
            });
        }

        // ═══════════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════════

        const canvases = [];
        const CANVAS_HEIGHT = 300;

        function initStages() {
            const container = document.getElementById('stages');
            container.innerHTML = '';
            canvases.length = 0;

            stages.forEach((stage, index) => {
                const div = document.createElement('div');
                div.className = 'stage';
                div.innerHTML = `
                    <div class="stage-header">
                        <div>
                            <span class="stage-number">Stage ${index + 1}</span>
                            <span class="stage-title">${stage.title.split(' - ')[1]}</span>
                        </div>
                        <div class="stage-metrics">
                            <div class="metric">Health: <span>${Math.round(stage.health * 100)}%</span></div>
                            <div class="metric">Engagement: <span>${Math.round(stage.metrics.engagement * 100)}%</span></div>
                            <div class="metric">Food: <span>${Math.round(stage.metrics.food * 100)}%</span></div>
                            <div class="metric">Ketones: <span>${Math.round(stage.metrics.ketone * 100)}%</span></div>
                            <div class="metric">Glucose: <span>${Math.round(stage.metrics.glucose * 100)}%</span></div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="canvas-${index}"></canvas>
                    </div>
                    <div class="stage-description">${stage.description}</div>
                `;
                container.appendChild(div);
            });

            requestAnimationFrame(() => {
                stages.forEach((stage, index) => {
                    const canvas = document.getElementById(`canvas-${index}`);
                    const cont = canvas.parentElement;
                    const displayWidth = cont.clientWidth || 800;
                    const displayHeight = CANVAS_HEIGHT;
                    const dpr = window.devicePixelRatio || 1;

                    canvas.width = displayWidth * dpr;
                    canvas.height = displayHeight * dpr;
                    canvas.style.width = displayWidth + 'px';
                    canvas.style.height = displayHeight + 'px';

                    canvases.push({ canvas, stage, displayWidth, displayHeight, dpr });
                });
            });
        }

        function render(timestamp) {
            const time = timestamp * 0.001;
            canvases.forEach(({ canvas, stage, displayWidth, displayHeight, dpr }) => {
                const ctx = canvas.getContext('2d');
                ctx.save();
                ctx.scale(dpr, dpr);
                drawScene(ctx, stage, displayWidth, displayHeight, time);
                ctx.restore();
            });
            requestAnimationFrame(render);
        }

        function setTimeOfDay(t) {
            currentTimeOfDay = t;
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Start
        initStages();
        requestAnimationFrame(render);
        window.addEventListener('resize', initStages);
    </script>
</body>
</html>
